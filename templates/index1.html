<!DOCTYPE HTML>
<html>
<head>
	<title> Realtime voice chat </title>
	<script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">

    $(document).ready(function(){
    	namespace = '/test';

    	var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

    	socket.on('connected', function(msg){
    		$('#log').append('<br>' + $('<div/>').text('message : ' + msg.data).html());
    	});
    });

    // function __log(data) {
    //     // logg.innerHTML += "\n" + e + " " + (data || '');
    //     console.log(data)
    // }

    // var audio_context;
    // var recorder;

    // function startUserMedia(stream) {
    // var input = audio_context.createMediaStreamSource(stream);
    //     __log('Media stream created.');
    //     // Uncomment if you want the audio to feedback directly
    //     //input.connect(audio_context.destination);
    //     //__log('Input connected to audio context destination.');
        
    //     recorder = new Recorder(input);
    //     __log('Recorder initialised.');
    // }

    // window.onload = function init() {
    // try {
    //     // webkit shim
    //     window.AudioContext = window.AudioContext || window.webkitAudioContext;
    //     navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
    //     window.URL = window.URL || window.webkitURL;
      
    //     audio_context = new AudioContext;
    //     __log('Audio context set up.');
    //     __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
    //     } catch (e) {
    //         alert('No web audio support in this browser!');
    //     }
    
    //     navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
    //         __log('No live audio input: ' + e);
    //     });
    // };

    // recorder = startUserMedia

    // recorder && recorder.record();
    // __log('Recording...');

    // sleepFor(1000)

    // recorder && recorder.stop();
    // __log('Stopped recording.');
    
    // // create WAV download link using audio data blob
    
    // //recorder.clear();

    // function sleepFor( sleepDuration ){
    //     var now = new Date().getTime();
    //     while(new Date().getTime() < now + sleepDuration){/* do nothing */} 
    // }

    </script>
</head>

<body>
    Say anything
    <h2>Received:</h2>
    <div id ="log"></div>
    <pre id ="logg"></pre>
    <script>
    function hasGetUserMedia() {
    return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia || navigator.msGetUserMedia);
    }

    if (hasGetUserMedia()) {
    // Good to go!
    } else {
    alert('getUserMedia() is not supported in your browser');
    }

    </script>
    <audio autoplay></audio>

    <script>

    function __log(data) {
        // logg.innerHTML += "\n" + e + " " + (data || '');
        console.log(data)
    }

    var audio_context;
    var recorder;

    function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
        __log('Media stream created.');
        // Uncomment if you want the audio to feedback directly
        //input.connect(audio_context.destination);
        //__log('Input connected to audio context destination.');
        
        recorder = new Recorder(input);
        __log('Recorder initialised.');
    }

    window.onload = function init() {
    try {
        // webkit shim
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
        window.URL = window.URL || window.webkitURL;
      
        audio_context = new AudioContext;
        __log('Audio context set up.');
        __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
        } catch (e) {
            alert('No web audio support in this browser!');
        }
    
        navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
            __log('No live audio input: ' + e);
        });
    };

    recorder = startUserMedia

    recorder && recorder.record();
    __log('Recording...');

    sleepFor(1000)

    recorder && recorder.stop();
    __log('Stopped recording.');
    
    // create WAV download link using audio data blob
    
    //recorder.clear();

    function sleepFor( sleepDuration ){
        var now = new Date().getTime();
        while(new Date().getTime() < now + sleepDuration){/* do nothing */} 
    }
    </script>
</body>
</html>
